# ==============================
# MULTI-STAGE DOCKERFILE DASH
# WhatsApp Agent Dashboard v2.0
# ==============================

# Stage 1: Builder - Dependencies compilation
FROM python:3.11-slim as builder

# OtimizaÃ§Ãµes de build
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# Instalar dependÃªncias de build
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    libpq-dev \
    pkg-config \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Instalar dependÃªncias Python
COPY requirements.txt .
RUN pip install --upgrade pip wheel setuptools
RUN pip install --user --no-warn-script-location -r requirements.txt

# DependÃªncias especÃ­ficas do Dash
RUN pip install --user --no-warn-script-location \
    dash==2.14.1 \
    dash-bootstrap-components==1.4.1 \
    plotly==5.17.0 \
    pandas>=2.2.0 \
    gunicorn

# Copiar e compilar cÃ³digo
COPY . .
RUN python -m compileall . -q

# ==============================
# Stage 2: Runtime - Dash optimized
FROM python:3.11-slim as runtime

# ðŸ”’ SEGURANÃ‡A: Criar usuÃ¡rio nÃ£o-root para Dash
RUN groupadd --gid 1001 dashuser && \
    useradd --uid 1001 --gid dashuser --shell /bin/bash --create-home dashuser

# Instalar dependÃªncias runtime mÃ­nimas
RUN apt-get update && apt-get install -y \
    libpq5 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Configurar aplicaÃ§Ã£o
WORKDIR /home/dashuser/app
RUN chown -R dashuser:dashuser /home/dashuser/app

# Copiar dependÃªncias Python do builder
COPY --from=builder --chown=dashuser:dashuser /root/.local /home/dashuser/.local

# Copiar cÃ³digo fonte
COPY --from=builder --chown=dashuser:dashuser /app /home/dashuser/app

# ðŸ”’ SEGURANÃ‡A: Mudar para usuÃ¡rio nÃ£o-root
USER dashuser

# Configurar PATH para binÃ¡rios locais
ENV PATH=/home/dashuser/.local/bin:$PATH

# ConfiguraÃ§Ãµes do Dash
ENV DASH_DEBUG=False
ENV DASH_DEV_TOOLS_HOT_RELOAD=False
ENV DASH_DEV_TOOLS_SERVE_DEV_BUNDLES=False

# ConfiguraÃ§Ãµes de rede
ENV HOST=0.0.0.0
ENV PORT=8050

# ConfiguraÃ§Ãµes Python
ENV PYTHONPATH=/home/dashuser/app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Healthcheck para Dash
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8050/ || exit 1

# ðŸš€ COMANDO: Executar Dashboard Dash
EXPOSE 8050
CMD ["python", "dashboard_whatsapp_complete.py"]
