# ==============================
# DOCKERFILE DESENVOLVIMENTO
# WhatsApp Agent - Hot Reload & Debug
# ==============================

FROM python:3.11-slim as development

# Metadados
LABEL maintainer="WhatsApp Agent Team"
LABEL version="2.0-dev"
LABEL description="WhatsApp Agent Development Environment"

# Configurar timezone
ENV TZ=America/Sao_Paulo
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Instalar dependências de desenvolvimento
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    libpq-dev \
    postgresql-client \
    curl \
    git \
    vim \
    htop \
    iputils-ping \
    net-tools \
    && rm -rf /var/lib/apt/lists/*

# Criar usuário de desenvolvimento
RUN groupadd -g 1000 developer && \
    useradd -r -u 1000 -g developer -d /home/developer -s /bin/bash developer && \
    mkdir -p /home/developer && \
    chown -R developer:developer /home/developer

WORKDIR /home/developer/app

# Instalar dependências Python
COPY requirements.txt requirements-test.txt ./
RUN pip install --upgrade pip wheel setuptools
RUN pip install -r requirements.txt
RUN pip install -r requirements-test.txt

# Dependências de desenvolvimento adicionais
RUN pip install \
    pytest-watch \
    black \
    isort \
    flake8 \
    mypy \
    pre-commit \
    ipython \
    jupyter

# Criar estrutura para desenvolvimento
RUN mkdir -p \
    logs/{app,test,debug} \
    backups \
    config \
    tests \
    .pytest_cache \
    && chown -R developer:developer logs backups config tests .pytest_cache

# Variáveis de ambiente para desenvolvimento
ENV PYTHONPATH=/home/developer/app
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV FASTAPI_ENV=development
ENV DEBUG=true
ENV HOT_RELOAD=true

USER developer

# Health check simplificado para dev
HEALTHCHECK --interval=60s --timeout=30s --start-period=30s --retries=2 \
    CMD curl -f http://localhost:8000/health || exit 1

EXPOSE 8000

# Comando para desenvolvimento com hot reload
CMD ["python", "-m", "uvicorn", "app.main:app", \
     "--host", "0.0.0.0", \
     "--port", "8000", \
     "--reload", \
     "--reload-dir", "/home/developer/app", \
     "--log-level", "debug"]
